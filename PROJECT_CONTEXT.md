# Карточный движок — контекст проекта

Этот файл хранит подробный контекст проекта, чтобы не перегружать `AGENTS.md`.

## Продуктовые цели
- Универсальный событийный движок, не привязанный к одному набору правил.
- Поддержка разных типов карточных игр: Hearthstone‑like, Magic‑like, Slay the Spire, Gwent, классические карточные.
- Headless‑ядро + адаптеры представления (DOM/Canvas/CLI).

## Архитектура (сводка)
**Фиксированная структура хода** по умолчанию:
```
phases: ['draw', 'main', 'combat', 'end']
```
Поведение расширяется хуками:
```
onPhaseStart(phase, context) { ... }
onCardPlay(card, context) { ... }
```

**Событийная модель**
- Всё в игре — это события и реакции на них.
- Карты/механики подписываются на события через триггеры с условиями и приоритетом.

**Effect Resolver (слой разрешения)**
- Собирает модификаторы эффекта.
- Применяет в детерминированном порядке по `priority`.
- Отделяет модификацию эффекта от его исполнения.

## Данные и правила
- Карты — данные (JSON5).
- Правила и ядро — TypeScript.
- Правила должны поддерживать сложные многоступенчатые механики из коробки.

## Режимы и плагины
Примеры:
```
GameEngine.use(new GraveyardPlugin())
GameEngine.use(new ManaSystemPlugin())

modes/draft.json
modes/constructed.json
```

## Сеть
- Локальная игра (MVP) + hot‑seat.
- Онлайн: клиент‑сервер, сервер авторитетен.
- WebSocket для real‑time обновлений состояния.

## Производительность
- Core < 42KB gzipped (только логика).
- UI‑адаптеры +20–40KB.
- Цель: 60 FPS, ход < 20ms при сложных эффектах.
- 1000+ карт без лагов.

## Детерминизм и replay
- Детерминированные результаты при одинаковых состояниях.
- Seeded RNG для воспроизводимости.
- Логи пригодны для replay/валидации.

## Базовые концепции
**События**
- `beforeCardPlay`, `onCardPlayed`, `afterCardPlay`
- `beforeDamage`, `onDamage`, `afterDamage`
- `turnStart`, `turnEnd`, `phaseChange`
- `onDeath`, `onHeal`, `onDraw`

**Модель сущности**
```
entity: {
  id: string,
  type: string,
  stats: Map<string, number>,
  tags: Set<string>,
  state: any
}
```

**Конфигурируемые зоны**
```
zones: ["hand", "deck", "discard", "exile", "field", "row1", "row2"]
```

## Принципы проектирования
- Предсказуемость важнее “магии”: явные фазы, явные эффекты, явный порядок.
- Никаких скрытых глобальных побочных эффектов.
- События и эффекты должны быть трассируемыми и воспроизводимыми.
- Ядро не знает о конкретных типах карт — всё описывается данными и правилами.
